trigger:
- main  # ou la branche que vous souhaitez surveiller

pool:
  vmImage: 'ubuntu-latest'

steps:
- checkout: self
  persistCredentials: true  # nécessaire pour pousser dans le repo .wiki

- script: |
    echo "Récupération du dernier commit"
    COMMIT_HASH=$(git log -1 --pretty=format:"%H")
    COMMIT_MSG=$(git log -1 --pretty=format:"%s")

    echo "Commit Hash: $COMMIT_HASH"
    echo "Commit Msg : $COMMIT_MSG"

    # Création d'un fichier Markdown
    mkdir wiki-temp
    echo "# Dernier commit" > wiki-temp/DernierCommit.md
    echo "- **Hash** : $COMMIT_HASH" >> wiki-temp/DernierCommit.md
    echo "- **Message** : $COMMIT_MSG" >> wiki-temp/DernierCommit.md
  displayName: "Créer page Markdown avec dernier commit"
  name: GenerateMarkdown

- script: |
    echo "Clonage du repo Wiki"
    git clone https://$(System.AccessToken)@dev.azure.com/$(System.CollectionUri)/$(System.TeamProject)/_git/$(Build.Repository.Name).wiki wiki-repo
    cp wiki-temp/DernierCommit.md wiki-repo/
    cd wiki-repo
    git config user.email "build@azuredevops"
    git config user.name "Azure DevOps"
    git add .
    git commit -m "Mise à jour du dernier commit"
    git push
  displayName: "Pousser la page dans le Wiki"
  env:
    SYSTEM_ACCESSTOKEN: $(System.AccessToken)
